var gdjs;(function(h){let D;(function(w){const p=class{constructor(t,e){this._transformation=new h.AffineTransformation;this._inverseTransformation=new h.AffineTransformation;this._transformationUpToDateCount=1;this._source=t,this.tag=e,this._layers=new Map,this._buildLayersFromTileMap(t,this._layers)}updateFromTileMap(t){this._source=t,this._layers=new Map,this._buildLayersFromTileMap(t,this._layers)}_buildLayersFromTileMap(t,e){for(const r of t.getLayers()){if(!(r instanceof TileMapHelper.EditableTileMapLayer))continue;const n=r;e.set(n.id,new v(this,n))}}getTransformation(){return this._transformation}setTransformation(t){this._transformation=t;const e=this._inverseTransformation;e.copyFrom(t),e.invert(),this._invalidate()}_invalidate(){this._transformationUpToDateCount=(this._transformationUpToDateCount+1)%Number.MAX_SAFE_INTEGER}getWidth(){return this._source.getWidth()}getHeight(){return this._source.getHeight()}getTileHeight(){return this._source.getTileHeight()}getTileWidth(){return this._source.getTileWidth()}getDimensionX(){return this._source.getDimensionX()}getDimensionY(){return this._source.getDimensionY()}getTileDefinition(t){return this._source.getTileDefinition(t)}getLayer(t){return this._layers.get(t)}getLayers(){return this._layers.values()}pointIsInsideTile(t,e,r){const n=p.workingPoint;return n[0]=t,n[1]=e,this._inverseTransformation.transform(n,n),this._source.pointIsInsideTile(n[0],n[1],r)}getHitboxesAround(t,e,r,n,s){const o=this._inverseTransformation,i=p.workingPoint;i[0]=e,i[1]=r,o.transform(i,i);const a=i[0],l=i[1];i[0]=n,i[1]=r,o.transform(i,i);const f=i[0],g=i[1];i[0]=n,i[1]=s,o.transform(i,i);const y=i[0],T=i[1];i[0]=e,i[1]=s,o.transform(i,i);const b=i[0],H=i[1],I=Math.max(0,Math.floor(Math.min(a,f,y,b)/this._source.getTileWidth())),L=Math.min(this.getDimensionX()-1,Math.floor(Math.max(a,f,y,b)/this._source.getTileWidth())),P=Math.max(0,Math.floor(Math.min(l,g,T,H)/this._source.getTileHeight())),C=Math.min(this.getDimensionY()-1,Math.floor(Math.max(l,g,T,H)/this._source.getTileHeight()));return this.getHitboxes(t,I,P,L,C)}getHitboxes(t,e,r,n,s){return new d(this,t,e,r,n,s)}getAllHitboxes(t){return this.getHitboxes(t,0,0,this._source.getDimensionX()-1,this._source.getDimensionY()-1)}};let _=p;_.workingPoint=[0,0],w.TransformedCollisionTileMap=_;const x=class{constructor(t,e,r,n,s,o){this.map=t,this.tag=e,this.xMin=r,this.yMin=n,this.xMax=s,this.yMax=o}[Symbol.iterator](){let t=this.map.getLayers()[Symbol.iterator](),e=x.emptyItr;return{next:()=>{let r=e.next();for(;r.done;){const n=t.next();if(n.done)return r;e=n.value.getHitboxes(this.tag,this.xMin,this.yMin,this.xMax,this.yMax)[Symbol.iterator](),r=e.next()}return r}}}};let d=x;d.emptyItr={next:()=>({value:void 0,done:!0})};class v{constructor(t,e){this.tileMap=t,this._source=e,this._tiles=[];const r=this._source.getDimensionX(),n=this._source.getDimensionY();this._tiles.length=n;for(let s=0;s<n;s++){this._tiles[s]=[],this._tiles[s].length=r;for(let o=0;o<r;o++)this._tiles[s][o]=new c(this,o,s)}}get(t,e){const r=this._tiles[e];return r?r[t]:void 0}getDimensionX(){return this._tiles.length===0?0:this._tiles[0].length}getDimensionY(){return this._tiles.length}getWidth(){return this._source.getWidth()}getHeight(){return this._source.getHeight()}isFlippedDiagonally(t,e){return this._source.isFlippedDiagonally(t,e)}isFlippedVertically(t,e){return this._source.isFlippedVertically(t,e)}isFlippedHorizontally(t,e){return this._source.isFlippedHorizontally(t,e)}getHitboxes(t,e,r,n,s){return new m(this,t,e,r,n,s)}getAllHitboxes(t){return this.getHitboxes(t,0,0,this.getDimensionX()-1,this.getDimensionY()-1)}}w.TransformedCollisionTileMapLayer=v;const u=class{constructor(t,e,r,n,s,o){this.layer=t,this.tag=e,this.xMin=r,this.yMin=n,this.xMax=s,this.yMax=o}[Symbol.iterator](){let t=this.xMax,e=this.yMin-1,r=u.emptyItr;return{next:()=>{let n=r.next();for(;n.done;){if(t++,t>this.xMax&&(e++,t=this.xMin),e>this.yMax)return n;const s=this.layer.get(t,e);if(!s)continue;const o=s.getDefinition();!o||o.hasTaggedHitBox(this.tag)&&(r=s.getHitboxes()[Symbol.iterator](),n=r.next())}return n}}}};let m=u;m.emptyItr={next:()=>({value:void 0,done:!0})};const M=class{constructor(t,e,r){this.affineTransformationUpToDateCount=0;this.layer=t,this.x=e,this.y=r;const n=this.getDefinition();if(this.hitBoxes=[],n){const s=this.layer.tileMap.tag,o=n.getHitBoxes(s);if(o){this.hitBoxes.length=o.length;for(let i=0;i<this.hitBoxes.length;i++){const a=new h.Polygon;this.hitBoxes[i]=a,a.vertices.length=o[i].length;for(let l=0;l<a.vertices.length;l++)a.vertices[l]=[0,0]}}}}getDefinition(){return this.layer.tileMap.getTileDefinition(this.layer._source.getTileId(this.x,this.y))}_isHitboxesUpToDate(){return this.affineTransformationUpToDateCount===this.layer.tileMap._transformationUpToDateCount}_setHitboxesUpToDate(){this.affineTransformationUpToDateCount=this.layer.tileMap._transformationUpToDateCount}getHitboxes(){if(this._isHitboxesUpToDate())return this.hitBoxes;const t=this.getDefinition();if(!t)return this._setHitboxesUpToDate(),this.hitBoxes.length=0,this.hitBoxes;const e=this.layer.tileMap.tag,r=t.getHitBoxes(e);if(!r)return this._setHitboxesUpToDate(),this.hitBoxes.length=0,this.hitBoxes;const n=this.layer.tileMap.getTransformation(),s=this.layer.tileMap.getTileWidth(),o=this.layer.tileMap.getTileHeight(),i=M.workingTransformation;i.setToTranslation(s*this.x,o*this.y),this.layer.isFlippedHorizontally(this.x,this.y)&&i.flipX(s/2),this.layer.isFlippedVertically(this.x,this.y)&&i.flipY(o/2),this.layer.isFlippedDiagonally(this.x,this.y)&&(i.flipX(s/2),i.rotateAround(Math.PI/2,s/2,o/2)),i.preConcatenate(n);for(let a=0;a<this.hitBoxes.length;a++){const l=r[a],f=this.hitBoxes[a];for(let g=0;g<f.vertices.length;g++){const y=l[g],T=f.vertices[g];i.transform(y,T)}}return this._setHitboxesUpToDate(),this.hitBoxes}};let c=M;c.workingTransformation=new h.AffineTransformation})(D=h.TileMap||(h.TileMap={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=TransformedTileMap.js.map
